---
# title: NABat Acoustic Report
---

<style>
body{
  font-family: 'Oxygen', sans-serif;
  font-size: 16px;
  line-height: 24px;
  padding-top: 100px;
  padding-bottom: 40px;
}

h1,h2,h3,h4 {
  font-family: 'Raleway', sans-serif;
}

.main-container { 
  width: 1000px;
}
h3 {
  background-color: #D4DAEC;
  text-indent: 50px;
  margin: 5px;
  padding: 5px
}
h4 {
  text-indent: 0px;
}

g-table-intro h4 {
  text-indent: 0px;
}
</style>

<a href='https://sciencebase.usgs.gov/nabat/#/home'><img style="position: absolute; top: 0; left: 30px ; border: 0; width:250px;" src='`r nabat_png`' /></a>

# NABat Interactive Stationary Acoustic Report: **`r project_id`**
#### **Project**:  `r project_id`

### Locations of all the acoustic data for this project
```{r, echo = FALSE, warning = FALSE, message = FALSE}
grts_map

# This needs to point to the src that is paste0(getOption('nabat_path'), '/data/templates/nabat_logo.png'))
# <a href='https://sciencebase.usgs.gov/nabat/#/home'><img style="position: absolute; top: 0; left: 30px ; border: 0; width:250px;" src='data/nabat_logo.png' /></a>
```

### Auto Species at GRTS (wide)
<br>
```{r, echo=FALSE}
# Pie chart with all species and their percentages
df = auto_species_totals_w$species_grts_df
kable(df) %>%
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed')) %>%
  scroll_box(height='400px', width = '100%')
```

### Manual Species at GRTS (wide)
<br>
```{r, echo=FALSE}
# Pie chart with all species and their percentages
df = manual_species_totals_w$species_grts_df
kable(df) %>%
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed')) %>%
  scroll_box(height='400px', width = '100%')
```

### AUTO Species at Project 
<br>
```{r, echo=FALSE}
# Pie chart with all species and their percentages
df = auto_species_totals_w$species_grts_df %>% dplyr::select(names, species_totals) %>% subset(names != 'grts_totals' & names != '25k' & names != 'NoID')

color_count = dim(auto_species_totals_w$species_grts_df)[1] -3
# pie_colors  = colorRampPalette(c("#0f4f7e", "#FFE9AB", "#821206"))(color_count)
pie_colors  = rainbow(color_count)

df_p = plot_ly(data = df, values = df$species_totals, type = 'pie', width='100%',
                               marker = list(colors = pie_colors,
                                             line = list(color = 'white', width = 1)),
                               text = df$names,
                               textposition = 'auto',
                               showlegend = FALSE,
                               textinfo = 'text+percent+value')
df_p
```

### MANUAL Species at Project 
<br>
```{r, echo=FALSE}
# Pie chart with all species and their percentages
df = manual_species_totals_w$species_grts_df %>% dplyr::select(names, species_totals) %>% subset(names != 'grts_totals' & names != '25k' & names != 'NoID')

color_count = dim(manual_species_totals_w$species_grts_df)[1] -3
# pie_colors  = colorRampPalette(c("#0f4f7e", "#FFE9AB", "#821206"))(color_count)
pie_colors  = rainbow(color_count)

df_p = plot_ly(data = df, values = df$species_totals, type = 'pie', width='100%',
                               marker = list(colors = pie_colors,
                                             line = list(color = 'white', width = 1)),
                               text = df$names,
                               textposition = 'auto',
                               showlegend = FALSE,
                               textinfo = 'text+percent+value')
df_p
```

### Auto Species at GRTS (long)
<br>
```{r, echo=FALSE}
# Pie chart with all species and their percentages
df = auto_species_totals_l
kable(df) %>%
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed')) %>%
  scroll_box(height='400px', width = '100%')
```

### Manual Species at GRTS (long)
<br>
```{r, echo=FALSE}
# Pie chart with all species and their percentages
df = manual_species_totals_l
kable(df) %>%
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed')) %>%
  scroll_box(height='400px', width = '100%')
```






### Observed night plot for stationary acoustic data

```{r, echo = FALSE, warning = FALSE, message = FALSE}
# build dynamic plotly plots

# library(plotly)
# library(RColorBrewer)
# library(ggplot2)

build_grts_plots = function(ordered_combined_data){
    # sites
    grts_id = unique(ordered_combined_data$GRTS)
    sites = unique(ordered_combined_data$site_id)

    # Clean data at GRTS level to remove any species that aren't at this GRTS cell
    species_grts_df = dplyr::select(ordered_combined_data, -c('GRTS', 'site_id', 'site_name', 'observed_night', 'type', 'project_id'))
    species_present_grts = names(species_grts_df[,colSums(species_grts_df) > 0])

    # Clean data to include headers
    cleaned_grts_df = dplyr::select(ordered_combined_data, c('GRTS', 'site_id', 'site_name', 'observed_night', 'type', species_present_grts))

    # Build color palette to use for all sites in this grts cell
    n = length(species_present_grts)
    color_palette = colorRampPalette(c("#29a4ff", "#ffd25c", "#8a443d"))(n)
    color_palette_op = colorRampPalette(c("#82caff", "#fff0c7", "#d6a7a3"))(n)
    color_palette_df = data.frame(colors = color_palette, op_colors = color_palette_op, species = species_present_grts)

    site_count_list = list()
    for (site in sites){
      # Subset data on a site level within a GRTS cell
      cleaned_site_df = subset(cleaned_grts_df, cleaned_grts_df$site_id == site)
      cleaned_site_df$opacity = ifelse(cleaned_site_df$type == 'automatic', 1, .5)
      cleaned_site_df$x_names = paste0(cleaned_site_df$observed_night,'_', cleaned_site_df$type)
      dates = as.character(cleaned_site_df$observed_night)

      # # Clean data again at site level to remove any species that aren't at this site
      # species_site_df = dplyr::select(cleaned_site_df, -c('GRTS', 'site_id', 'site_name', 'observed_night'))
      # species_present_site = names(species_site_df[,colSums(species_site_df) > 0])
      # cleaned_site_df = dplyr::select(cleaned_site_df, c('GRTS', 'site_id', 'site_name', 'observed_night', species_present_site))

      plotly_ = FALSE
      count = 0
      width_ = .1

      for (name in species_present_grts){
        count = count + 1
        species_counts = cleaned_site_df[,name]
        color = as.character(subset(color_palette_df, species == name)$colors)
        opac_color = as.character(subset(color_palette_df, species == name)$op_colors)

        this_color = rep(c(color, opac_color), length(species_counts)/2)

        if (plotly_ == FALSE){
          plotly_ = TRUE
          p_species = plot_ly(x = species_counts, y = cleaned_site_df$x_names, type = 'bar', orientation = 'h',
                              name = name, text = site, legendgroup = site,
                              marker = list(color = color,
                                            line = list(color = 'black',
                                                        width = width_)))
        }else{
          p_species = p_species %>% add_trace(x = species_counts, name = name,
                                              text = site, legendgroup = site,
                              marker = list(color = color,
                                            line = list(color = 'black',
                                                        width = width_)))
        }
      }
      m = list(l = 50,
               r = 50,
               b = 100,
               t = 50,
               pad = 4)
      p_species_final = p_species %>%
            layout(barmode = 'stack',
                    xaxis = list(title = "Counts"),
                    yaxis = list(title = "Observed Night"),
                    title = paste0(site),
                    autosize = F,
                    # width = 800,
                    # height = 500,
                    margin = m)
    }
    return (p_species_final)
}
```

```{r, echo = FALSE, warning = FALSE, message = FALSE}

# re-order dataframe by site_id, then observed_night
ordered_grts_df_auto = auto_nights_df[order(auto_nights_df$site_id, auto_nights_df$observed_night),]
ordered_grts_df_auto = dplyr::select(ordered_grts_df_auto, -c('25k','NoID'))
ordered_grts_df_auto$type = 'automatic'

ordered_grts_df_man = manual_nights_df[order(manual_nights_df$site_id, manual_nights_df$observed_night),]
ordered_grts_df_man = dplyr::select(ordered_grts_df_man, -c('25k','NoID'))
ordered_grts_df_man$type  = 'manual'

combined_data = rbind(ordered_grts_df_auto, ordered_grts_df_man)
ordered_combined_data_ = combined_data[order(combined_data$site_id, combined_data$observed_night),]

split_list = ordered_combined_data_ %>% split(ordered_combined_data_$site_id)
# split_list = ordered_combined_data_ %>% split(ordered_combined_data_$GRTS)
plot_list = lapply(split_list[1],  build_grts_plots)

subplot(plot_list, nrows = length(plot_list)) %>%
  layout(height = length(plot_list) * 500, width = 800)


# subplot(plot_list, nrows = 3) %>%
#   layout(width = 800, height = 800)

# subplot(plot_list, nrows = rows, heights= heights, widths=widths,
#         margin=.01 ,shareY = F) %>%
#   layout(width = 1000, height = plot_dims$rows*200)
```

### Manual species counts
```{r, echo = FALSE, warning = FALSE, message = FALSE}

data = manual_species_grts_df_w %>% subset(names != 'grts_totals' & names != 'NoID' & names != '25k')
pm = plot_ly(x = data$names, y = data$species_totals) %>% layout(title = paste0('NABat Project ', project_id, ' manual Species counts'))
pm
```

### Automatic species counts
```{r, echo = FALSE, warning = FALSE, message = FALSE}

data = auto_species_grts_df_w %>% subset(names != 'grts_totals' & names != 'NoID' & names != '25k')
pa = plot_ly(x = data$names, y = data$species_totals) %>% layout(title = paste0('NABat Project ', project_id, ' automatic Species counts'))
pa
```





